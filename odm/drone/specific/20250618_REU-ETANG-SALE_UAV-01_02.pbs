#!/bin/bash

#PBS -q omp
#PBS -l select=1:ncpus=36:mem=100g
#PBS -l walltime=23:59:00
#PBS -N odm_drone_heavy_etang
#PBS -S /bin/bash

signal_handler() {
	pkill --parent "${$}"
}
trap signal_handler EXIT

module load singularity/3.6.4
cd /home1/datahome/villien/PBS/odm

SESSION_PATH=/scale/project/rummo/drone/drone_serge/20250618_REU-ETANG-SALE_UAV-01_02
NB_IMG=$(ls -v ${SESSION_PATH}/DCIM | wc -l)

echo "Working with ${SESSION_PATH}"

PHOTOG_FOLDER=${SESSION_PATH}/PROCESSED_DATA/PHOTOGRAMMETRY_HEAVY
mkdir -p ${PHOTOG_FOLDER}/images

for i in $(seq 1 $NB_IMG); do 
	ln -s ../../../DCIM/$(ls -v ${SESSION_PATH}/DCIM | sed -n "${i}p") ${PHOTOG_FOLDER}/images 
done

singularity run --bind ${SESSION_PATH}:/datasets/code \
odm_3_5_3.sif \
--project-path /datasets code/PROCESSED_DATA/PHOTOGRAMMETRY_HEAVY \
--auto-boundary --cog --orthophoto-resolution 1.0 --rolling-shutter \
--max-concurrency 36 --optimize-disk-space --feature-quality ultra --dtm --dsm --mesh-size 600000

qstat -f $PBS_JOBID
